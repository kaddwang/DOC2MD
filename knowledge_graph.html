<!DOCTYPE html>
<html lang="zh-TW">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>MAAC Knowledge Graph</title>
<script src="https://unpkg.com/vis-network/standalone/umd/vis-network.min.js"></script>
<style>
  :root {
    --bg-color: #F5F5F7; /* Apple Light Gray */
    --panel-bg: rgba(255, 255, 255, 0.85);
    --text-primary: #1D1D1F;
    --text-secondary: #86868B;
    --accent-blue: #0071E3;
    --accent-green: #34C759;
    --accent-orange: #FF9500;
    --accent-purple: #AF52DE;
    --shadow-sm: 0 2px 8px rgba(0,0,0,0.04);
    --shadow-md: 0 8px 24px rgba(0,0,0,0.08);
  }
  
  * { margin:0; padding:0; box-sizing:border-box; outline:none; -webkit-font-smoothing: antialiased; }
  body {
    font-family: -apple-system, BlinkMacSystemFont, "SF Pro Text", "Segoe UI", Roboto, sans-serif;
    background: var(--bg-color);
    color: var(--text-primary);
    overflow: hidden;
  }

  #graph-container { width:100vw; height:100vh; background: var(--bg-color); }

  /* --- UI CONTROLS --- */
  .floating-panel {
    position: fixed; z-index: 100;
    background: var(--panel-bg);
    backdrop-filter: blur(20px); -webkit-backdrop-filter: blur(20px);
    border: 1px solid rgba(255,255,255,0.4);
    box-shadow: var(--shadow-sm);
    border-radius: 18px;
    transition: all 0.3s cubic-bezier(0.25,0.8,0.25,1);
  }

  /* TOP BAR */
  #top-bar {
    top: 20px; left: 20px; right: 20px;
    padding: 12px 20px;
    display: flex; align-items: center; gap: 16px; flex-wrap: wrap;
    max-width: 1400px; margin: 0 auto;
  }
  
  .app-title {
    font-size: 14px; font-weight: 700; color: var(--text-primary);
    display: flex; align-items: center; gap: 8px; margin-right: 12px;
  }
  .app-title span {
    font-weight: 400; color: var(--text-secondary); background: rgba(0,0,0,0.05);
    padding: 2px 8px; border-radius: 6px; font-size: 11px;
  }

  /* Search */
  .search-wrapper { position: relative; flex: 1; max-width: 300px; }
  .search-wrapper input {
    width: 100%; padding: 8px 12px 8px 36px;
    border-radius: 10px; border: none;
    background: rgba(0,0,0,0.05); color: var(--text-primary);
    font-size: 13px; transition: all 0.2s;
  }
  .search-wrapper input:focus { background: #fff; box-shadow: 0 0 0 2px var(--accent-blue); }
  .search-icon { position: absolute; left: 10px; top: 50%; transform: translateY(-50%); font-size: 12px; opacity: 0.5; }

  /* Filters */
  .filter-group { display: flex; gap: 6px; background: rgba(0,0,0,0.05); padding: 4px; border-radius: 12px; }
  .filter-btn {
    border: none; background: transparent; padding: 6px 12px;
    border-radius: 8px; font-size: 12px; font-weight: 500; color: var(--text-secondary);
    cursor: pointer; transition: all 0.2s;
  }
  .filter-btn:hover { color: var(--text-primary); background: rgba(255,255,255,0.5); }
  .filter-btn.active { background: #fff; color: var(--text-primary); box-shadow: 0 2px 4px rgba(0,0,0,0.05); }

  /* Actions */
  .action-btn {
    padding: 8px 16px; border-radius: 20px; border: none;
    font-size: 12px; font-weight: 600; cursor: pointer;
    transition: transform 0.1s;
  }
  .action-btn:active { transform: scale(0.96); }
  .btn-primary { background: var(--text-primary); color: #fff; }
  .btn-primary:hover { background: #000; }
  .btn-impact { background: #FF3B30; color: #fff; }
  .btn-impact:hover { background: #D70015; }

  /* LEGEND */
  #legend {
    bottom: 24px; left: 24px; padding: 16px;
    width: 200px;
  }
  .legend-section { margin-bottom: 12px; }
  .legend-title { font-size: 10px; font-weight: 700; text-transform: uppercase; color: var(--text-secondary); margin-bottom: 8px; letter-spacing: 0.5px; }
  .legend-row { display: flex; align-items: center; gap: 8px; margin-bottom: 6px; font-size: 12px; color: var(--text-primary); }
  .dot { width: 8px; height: 8px; border-radius: 50%; }
  .pill { width: 16px; height: 10px; border-radius: 4px; border: 2px solid; background: #fff; }

  /* DETAIL PANEL */
  #detail-panel {
    top: 80px; right: 24px; bottom: 24px; width: 380px;
    transform: translateX(120%); padding: 0;
    display: flex; flex-direction: column;
    overflow: hidden;
  }
  #detail-panel.open { transform: translateX(0); }
  
  .panel-header { padding: 24px 24px 16px; border-bottom: 1px solid rgba(0,0,0,0.05); }
  .panel-title { font-size: 22px; font-weight: 700; line-height: 1.2; margin-bottom: 8px; }
  .panel-badge { 
    display: inline-flex; align-items: center; padding: 4px 10px; 
    border-radius: 12px; font-size: 11px; font-weight: 600; 
    text-transform: uppercase; letter-spacing: 0.5px;
  }
  
  .panel-body { flex: 1; overflow-y: auto; padding: 20px 24px; }
  .panel-desc { font-size: 14px; line-height: 1.6; color: #424245; margin-bottom: 24px; }
  
  .rel-section h4 { font-size: 11px; color: var(--text-secondary); text-transform: uppercase; margin: 0 0 8px; }
  .rel-list { display: flex; flex-direction: column; gap: 6px; margin-bottom: 20px; }
  .rel-item {
    display: flex; align-items: center; gap: 10px;
    padding: 10px; border-radius: 10px;
    background: rgba(0,0,0,0.03); cursor: pointer;
    transition: all 0.2s;
  }
  .rel-item:hover { background: rgba(0,113,227,0.08); transform: translateX(4px); }
  .rel-icon { font-size: 14px; }
  .rel-name { font-size: 13px; font-weight: 500; flex: 1; }
  .rel-type { font-size: 10px; color: var(--text-secondary); background: rgba(255,255,255,0.5); padding: 2px 6px; border-radius: 4px; }

  .close-btn { position: absolute; top: 16px; right: 16px; border: none; background: rgba(0,0,0,0.05); width: 28px; height: 28px; border-radius: 50%; cursor: pointer; }
  .close-btn:hover { background: rgba(0,0,0,0.1); }

  /* IMPACT BANNER */
  #impact-banner {
    top: 85px; left: 50%; transform: translateX(-50%) translateY(-20px);
    opacity: 0; pointer-events: none;
    background: #FF3B30; color: #fff;
    padding: 8px 24px; border-radius: 30px;
    display: flex; align-items: center; gap: 12px;
    box-shadow: 0 8px 20px rgba(255, 59, 48, 0.3);
    transition: all 0.4s cubic-bezier(0.34, 1.56, 0.64, 1);
  }
  #impact-banner.show { opacity: 1; transform: translateX(-50%) translateY(0); pointer-events: auto; }
  
  /* IMPACT LIST (Bottom Right) */
  #impact-list {
    bottom: 24px; right: 420px; width: 260px;
    max-height: 400px; overflow-y: auto;
    opacity: 0; pointer-events: none; transform: translateY(20px);
  }
  #impact-list.show { opacity: 1; pointer-events: auto; transform: translateY(0); }
  .impact-row { display: flex; align-items: center; padding: 8px; border-bottom: 1px solid rgba(0,0,0,0.05); cursor: pointer; }
  .impact-row:hover { background: rgba(0,0,0,0.02); }
  .depth-tag { background: #FF3B30; color: #fff; font-size: 10px; font-weight: 700; padding: 2px 6px; border-radius: 4px; margin-right: 8px; }

</style>
</head>
<body>

<div id="top-bar" class="floating-panel">
  <div class="app-title">MAAC <span>System Graph</span></div>
  
  <div class="search-wrapper">
    <span class="search-icon">üîç</span>
    <input type="text" id="search" placeholder="Search feature, module, API...">
  </div>

  <div class="filter-group" id="filters">
    <button class="filter-btn active" data-filter="all">All</button>
    <button class="filter-btn" data-filter="module">Modules</button>
    <button class="filter-btn" data-filter="subfeature">Features</button>
    <button class="filter-btn" data-filter="infra">Infra</button>
    <button class="filter-btn" data-filter="data">Data</button>
  </div>

  <div style="flex:1"></div>
  
  <button class="action-btn btn-impact" id="impact-btn">‚ö° Impact Analysis</button>
  <button class="action-btn" onclick="resetView()" style="color:#86868B;background:none">Reset</button>
</div>

<div id="graph-container"></div>

<!-- IMPACT UI -->
<div id="impact-banner">
  <span style="font-weight:700">Analysis Mode</span>
  <span style="opacity:0.8">|</span>
  <span id="impact-msg">Select a node to see dependencies</span>
  <button onclick="exitImpact()" style="background:rgba(255,255,255,0.2);border:none;color:#fff;border-radius:12px;padding:2px 10px;font-size:11px;cursor:pointer;margin-left:8px">Exit</button>
</div>

<div id="impact-list" class="floating-panel">
  <div style="padding:12px 16px; border-bottom:1px solid rgba(0,0,0,0.05); color:#FF3B30; font-weight:600; font-size:12px">‚ö†Ô∏è Affected Scope</div>
  <div id="impact-content"></div>
</div>

<!-- LEGEND -->
<div id="legend" class="floating-panel">
  <div class="legend-section">
    <div class="legend-title">Hierarchy</div>
    <div class="legend-row"><div class="pill" style="border-color:#007AFF;background:#E5F1FF"></div> Module</div>
    <div class="legend-row"><div class="pill" style="border-color:#34C759;background:#E8FBE8"></div> Feature</div>
    <div class="legend-row"><div class="dot" style="background:#FF9500"></div> Infra</div>
    <div class="legend-row"><div class="dot" style="background:#AF52DE"></div> Data</div>
  </div>
  <div class="legend-section">
    <div class="legend-title">Relationships</div>
    <div class="legend-row"><div style="width:20px;height:2px;background:#007AFF"></div> Data Flow</div>
    <div class="legend-row"><div style="width:20px;height:2px;background:#FF9500"></div> Dependency</div>
  </div>
</div>

<!-- DETAIL PANEL -->
<div id="detail-panel" class="floating-panel">
  <button class="close-btn" onclick="closeDetail()">√ó</button>
  <div id="detail-content"></div>
</div>

<script>
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
//  DATA INJECTION
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
const RAW_DATA = {"nodes": [{"id": 1, "label": "MAAC Platform", "group": "platform", "title": "Marketing Automation & Analytics Center\nCrescendo Lab's core product platform", "size": 50}, {"id": 2, "label": "Contact\nManagement", "group": "module", "title": "ËÅØÁµ°‰∫∫ÁÆ°ÁêÜÊ†∏ÂøÉ\nÁÆ°ÁêÜÊâÄÊúâÈÄöË∑ØÁöÑËÅØÁµ°‰∫∫Ë≥áÊñô\nÂåÖÂê´ LINE / FB / IG / Phone / Email", "size": 40}, {"id": 3, "label": "Segment", "group": "module", "title": "ÂàÜÁúæÂºïÊìé\nÊ†πÊìöÊ¢ù‰ª∂ÁØ©ÈÅ∏ËÅØÁµ°‰∫∫Áæ§ÁµÑ\nÊîØÊè¥ÈùúÊÖã/ÂãïÊÖãÂàÜÁúæ", "size": 36}, {"id": 4, "label": "Tag\nManager", "group": "module", "title": "Ê®ôÁ±§Á≥ªÁµ±\nTag CRUD„ÄÅËá™ÂãïÂä†Ê®ô„ÄÅÊ®ôÁ±§ÂàÜÊûê", "size": 34}, {"id": 5, "label": "Broadcast", "group": "module", "title": "Êé®Êí≠‰∏≠ÂøÉ\nÊéíÁ®ãÊé®Êí≠„ÄÅA/B Ê∏¨Ë©¶„ÄÅÂ§öÈÄöË∑ØÁôºÈÄÅ", "size": 38}, {"id": 6, "label": "Auto-reply", "group": "module", "title": "Ëá™ÂãïÂõûË¶Ü\nÈóúÈçµÂ≠óËß∏Áôº„ÄÅÊôÇÈñìÈôêÂà∂„ÄÅÈáçË§áÊéßÂà∂", "size": 34}, {"id": 7, "label": "Customer\nJourney", "group": "module", "title": "Ëá™ÂãïÂåñÊóÖÁ®ã\nÂ§öÊ≠•È©üËá™ÂãïÂåñÊµÅÁ®ã„ÄÅËß∏ÁôºÂô®„ÄÅÂãï‰ΩúÁØÄÈªû\nÂåÖÂê´ EDM Êï¥Âêà", "size": 42}, {"id": 8, "label": "Rich Menu", "group": "module", "title": "LINE ÂúñÊñáÈÅ∏ÂñÆ\nÊéíÁ®ã„ÄÅÂàÜÁúæÈ°ØÁ§∫„ÄÅÈÄ£ÁµêÁÆ°ÁêÜ", "size": 30}, {"id": 9, "label": "Insight\n& Reports", "group": "module", "title": "Êï∏ÊìöÂàÜÊûê\nTag Ë¶ÜËìãÁéá„ÄÅÁç≤ÂÆ¢ÊºèÊñó„ÄÅË®äÊÅØÁµ±Ë®à\nÊØèÊó•/ÊØèÈÄ±Â†±Ë°®", "size": 38}, {"id": 10, "label": "Deeplink", "group": "module", "title": "Ê∑±Â∫¶ÈÄ£Áµê\nUTM ËøΩËπ§„ÄÅÁç≤ÂÆ¢‰æÜÊ∫êÊ≠∏Âõ†", "size": 30}, {"id": 11, "label": "Tracelink", "group": "module", "title": "ÈÄ£ÁµêËøΩËπ§\nÈªûÊìäÂàÜÊûê„ÄÅËΩâÊèõËøΩËπ§", "size": 28}, {"id": 12, "label": "Prize\nManagement", "group": "module", "title": "ÁçéÂìÅÁÆ°ÁêÜ\nÁçéÂìÅÊ±†„ÄÅÂÖåÊèõÁ¢º„ÄÅÊäΩÁçéÁ≥ªÁµ±", "size": 28}, {"id": 13, "label": "Template\nLibrary", "group": "module", "title": "ÁØÑÊú¨Â∫´\nË®äÊÅØÁØÑÊú¨„ÄÅÂèØÈáçÁî®ÂÖßÂÆπÂçÄÂ°ä", "size": 26}, {"id": 14, "label": "Contact\nProfile", "group": "subfeature", "title": "ËÅØÁµ°‰∫∫Ê™îÊ°à\nÂßìÂêç„ÄÅÈõªË©±„ÄÅEmail„ÄÅËá™Ë®ÇÊ¨Ñ‰Ωç\nÂç≥ÊôÇÁ∑®ËºØËàáÂêåÊ≠•", "size": 18}, {"id": 15, "label": "Profile\nUnification", "group": "subfeature", "title": "Ë∑®ÈÄöË∑ØÂêà‰Ωµ\nLINE + SMS + Email Âêà‰ΩµÁÇ∫ÂñÆ‰∏ÄËÅØÁµ°‰∫∫\nÂêà‰ΩµÊ¨äÈáçÈÇèËºØ„ÄÅÊ¨Ñ‰ΩçË¶ÜÂØ´ÂÑ™ÂÖàÈ†ÜÂ∫è", "size": 22}, {"id": 16, "label": "Contact\nImport", "group": "subfeature", "title": "ËÅØÁµ°‰∫∫ÂåØÂÖ•\nCSV / API ÂåØÂÖ•„ÄÅKey Value ÂåπÈÖç\nÊîØÊè¥ line_uid / customer_id / phone / email", "size": 18}, {"id": 17, "label": "UID\nBinding", "group": "subfeature", "title": "Ë∫´‰ªΩÁ∂ÅÂÆö\nline_uid ‚Üî customer_id Â∞çÊáâ\nBindlink ÂõûÂëº„ÄÅCID Á∂ÅÂÆöÈÇèËºØ", "size": 18}, {"id": 18, "label": "Friend\nStatus", "group": "subfeature", "title": "LINE Â•ΩÂèãÁãÄÊÖã\nAuth / Following / Blocked\nÊ†πÊìö Webhook ‰∫ã‰ª∂ËøΩËπ§", "size": 16}, {"id": 19, "label": "Display\nName", "group": "subfeature", "title": "È°ØÁ§∫ÂêçÁ®±ÈÇèËºØ\ndisplay_name vs original_name\n‰æùË≥¥ LINE Channel Token ÂêåÊ≠•", "size": 16}, {"id": 20, "label": "Contact\nFields", "group": "subfeature", "title": "ËÅØÁµ°‰∫∫Ê¨Ñ‰Ωç\nname, phone, email, customer_id,\ntags, custom fields\nÊ¨Ñ‰ΩçÊõ¥Êñ∞Ë¶èÂâáÔºöÊúâÂÄºË¶ÜÂØ´„ÄÅÁ©∫ÂÄº‰øùÁïô", "size": 18}, {"id": 21, "label": "Filter\nConditions", "group": "subfeature", "title": "ÁØ©ÈÅ∏Ê¢ù‰ª∂ÂºïÊìé\nAND / OR ÈÇèËºØ„ÄÅTag ÁØ©ÈÅ∏\nÊó•Êúü„ÄÅ‰∫íÂãï„ÄÅ‰æÜÊ∫êÁ≠âÂ§öÈáçÊ¢ù‰ª∂", "size": 18}, {"id": 22, "label": "Dynamic\nSegment", "group": "subfeature", "title": "ÂãïÊÖãÂàÜÁúæ\nÊ¢ù‰ª∂ËÆäÊõ¥ÊôÇËá™ÂãïÊõ¥Êñ∞ÊàêÂì°\nËÉåÊôØÊéíÁ®ãË®àÁÆó", "size": 16}, {"id": 23, "label": "Tag\nCRUD", "group": "subfeature", "title": "Ê®ôÁ±§ÁÆ°ÁêÜ\nÂª∫Á´ã„ÄÅÁ∑®ËºØ„ÄÅÂà™Èô§Ê®ôÁ±§\nÊ®ôÁ±§ÂêçÁ®±„ÄÅÊéíÂ∫è", "size": 16}, {"id": 24, "label": "Auto-tag\nRules", "group": "subfeature", "title": "Ëá™ÂãïÂä†Ê®ôË¶èÂâá\n‰æù‰∫ã‰ª∂/Ë°åÁÇ∫Ëá™ÂãïÊ®ôË®òËÅØÁµ°‰∫∫", "size": 16}, {"id": 25, "label": "Message\nSend", "group": "subfeature", "title": "Ë®äÊÅØÁôºÈÄÅÂºïÊìé\nÊéíÁ®ãÁôºÈÄÅ„ÄÅÂç≥ÊôÇÁôºÈÄÅ\nÂ§öÈÄöË∑ØÔºàLINE / SMS / EmailÔºâ", "size": 18}, {"id": 26, "label": "A/B\nTesting", "group": "subfeature", "title": "A/B Ê∏¨Ë©¶\nÂ§öÁâàÊú¨Ë®äÊÅØÊØîËºÉ\nËá™ÂãïÈÅ∏ÊìáÊúÄ‰Ω≥ÁâàÊú¨", "size": 14}, {"id": 27, "label": "Audience\nTargeting", "group": "subfeature", "title": "ÂèóÁúæË®≠ÂÆö\n‰æù Segment ÈÅ∏ÊìáÊé®Êí≠Â∞çË±°", "size": 16}, {"id": 28, "label": "Keyword\nMatching", "group": "subfeature", "title": "ÈóúÈçµÂ≠óÊØîÂ∞ç\nÂÆåÂÖ®/ÈÉ®ÂàÜÂåπÈÖç„ÄÅÊ≠£Ââá\nËß∏ÁôºÂÑ™ÂÖàÈ†ÜÂ∫èÈÇèËºØ", "size": 16}, {"id": 29, "label": "Time & Reply\nLimits", "group": "subfeature", "title": "ÊôÇÈñì & Ê¨°Êï∏ÈôêÂà∂\nÂÜ∑ÂçªÊôÇÈñì„ÄÅÊØè‰∫∫ÊúÄÂ§ßÂõûË¶ÜÊ¨°Êï∏\nÈáçË§áË®äÊÅØÊéßÂà∂", "size": 16}, {"id": 30, "label": "Channel\nRestrictions", "group": "subfeature", "title": "ÈÄöË∑ØÈôêÂà∂\nMeta (FB/IG) ‰∏çÊîØÊè¥Êñ∞Â•ΩÂèãÈóúÈçµÂ≠óÂõûË¶Ü\nLINE / WhatsApp ÊîØÊè¥", "size": 14}, {"id": 31, "label": "Trigger\nEngine", "group": "subfeature", "title": "Ëß∏ÁôºÂºïÊìé\nEvent-BasedÔºöWebhook ‰∫ã‰ª∂È©ÖÂãï\nTime-BasedÔºöÊéíÁ®ãËß∏Áôº (Airflow)", "size": 20}, {"id": 32, "label": "Action\nNodes", "group": "subfeature", "title": "Âãï‰ΩúÁØÄÈªû\nSend Message / Add Tag / Wait\nCondition Split / A/B Split", "size": 20}, {"id": 33, "label": "EDM / Email\nAction", "group": "subfeature", "title": "Email ÁôºÈÄÅÁØÄÈªû\nMAAC ‚Üí Epistola ‚Üí SendGrid\nToken Exchange / iframe Á∑®ËºØÂô®", "size": 18}, {"id": 34, "label": "Member\nProgress", "group": "subfeature", "title": "ÊàêÂì°ÈÄ≤Â∫¶ËøΩËπ§\nREADY ‚Üí RUNNING ‚Üí WAITING ‚Üí ENDED\nÁãÄÊÖãÊ©üÁÆ°ÁêÜ", "size": 16}, {"id": 35, "label": "Node\nPerformance", "group": "subfeature", "title": "ÁØÄÈªûÁ∏æÊïàÊåáÊ®ô\nÊØèÁØÄÈªû send/open/click Áéá\nJourney Êï¥È´îËΩâÊèõÊºèÊñó", "size": 16}, {"id": 36, "label": "Tag\nCoverage", "group": "subfeature", "title": "Ê®ôÁ±§Ë¶ÜËìãÁéá\nÂÖ®ÂìÅÁâåÊ®ôÁ±§‰ΩøÁî®Áµ±Ë®à\n‰æùË≥¥ Airflow Êó•Â†±Ë°®", "size": 16}, {"id": 37, "label": "Acquisition\nFunnel", "group": "subfeature", "title": "Áç≤ÂÆ¢ÊºèÊñó\nÊñ∞ËÅØÁµ°‰∫∫‰æÜÊ∫ê„ÄÅËΩâÊèõÁéá\nDeeplink Â†±Ë°®", "size": 16}, {"id": 38, "label": "Message\nAnalytics", "group": "subfeature", "title": "Ë®äÊÅØÁµ±Ë®à\nÊé®Êí≠ÊàêÊïà„ÄÅÈñã‰ø°Áéá„ÄÅÈªûÊìäÁéá\nËá™ÂãïÂõûË¶ÜÊéíÂêç", "size": 16}, {"id": 39, "label": "Weekly\nReport", "group": "subfeature", "title": "ÊØèÈÄ±Â†±Ë°®\nËá™ÂãïÂØÑÈÄÅÁµ¶ÂÆ¢Êà∂\n‰æùË≥¥ Airflow ÊéíÁ®ã", "size": 14}, {"id": 40, "label": "UTM\nTracking", "group": "subfeature", "title": "UTM ÂèÉÊï∏ËøΩËπ§\n‰æÜÊ∫ê„ÄÅÂ™í‰ªã„ÄÅÊ¥ªÂãïÊ≠∏Âõ†", "size": 14}, {"id": 41, "label": "Acquisition\nSource", "group": "subfeature", "title": "Áç≤ÂÆ¢‰æÜÊ∫êËøΩËπ§\nÊñ∞ËÅØÁµ°‰∫∫Ê≠∏Âõ†Âà∞ Deeplink", "size": 14}, {"id": 42, "label": "Menu\nScheduling", "group": "subfeature", "title": "ÊéíÁ®ãÁÆ°ÁêÜ\nÊåâÊôÇÈñìÂàáÊèõ‰∏çÂêåÈÅ∏ÂñÆ", "size": 14}, {"id": 43, "label": "Per-audience\nMenu", "group": "subfeature", "title": "ÂàÜÁúæÈÅ∏ÂñÆ\n‰æùÊ®ôÁ±§/ÂàÜÁæ§È°ØÁ§∫‰∏çÂêåÈÅ∏ÂñÆ", "size": 14}, {"id": 44, "label": "Sender\nDomain", "group": "subfeature", "title": "Sender Domain ÁÆ°ÁêÜ\nDNS È©óË≠âÔºöCNAME / DKIM1 / DKIM2 / DMARC\nÈÄèÈÅé SendGrid API È©óË≠â", "size": 16}, {"id": 45, "label": "Channel\nStatus", "group": "subfeature", "title": "Email È†ªÈÅìÁãÄÊÖã\nnot_set ‚Üí connected ‚Üí warning ‚Üí suspended\nHard Bounce > 2% Êàñ Spam > 0.3% ‚Üí warning", "size": 16}, {"id": 46, "label": "CDH", "group": "infra", "title": "Customer Data Hub\nÁµ±‰∏ÄÂÆ¢Êà∂Ë≥áÊñô‰∏≠ÂøÉ\nË∑® MAAC / CAAC ÂêåÊ≠•ËÅØÁµ°‰∫∫", "size": 28}, {"id": 47, "label": "CAAC", "group": "infra", "title": "Conversational Analytics\n& Automation Center\nÂÆ¢ÊúçÂ∞çË©±Âπ≥Âè∞", "size": 24}, {"id": 48, "label": "LINE\nAPI", "group": "infra", "title": "LINE Messaging API\nWebhook„ÄÅPush/Reply Message\nProfile Sync„ÄÅFriend Status", "size": 26}, {"id": 49, "label": "Meta\nAPI", "group": "infra", "title": "Facebook + Instagram API\nË®äÊÅØÊî∂Áôº„ÄÅÁî®Êà∂Ë≥áÊñô\nÊúâÊîøÁ≠ñÈôêÂà∂", "size": 22}, {"id": 50, "label": "SendGrid", "group": "infra", "title": "Email ÁôºÈÄÅÊúçÂãô\nSender Domain È©óË≠â\nBounce / Spam Rate Áõ£Êéß", "size": 22}, {"id": 51, "label": "Airflow", "group": "infra", "title": "Ë≥áÊñôÁÆ°Á∑öÊéíÁ®ã\nÊØèÊó•Â†±Ë°® Pipeline\nÊéßÂà∂ Insight Ë≥áÊñôÊõ¥Êñ∞", "size": 22}, {"id": 52, "label": "RabbitMQ", "group": "infra", "title": "Ë®äÊÅØ‰ΩáÂàó\nJourney ‰∫ã‰ª∂ÂàÜÁôº\nWorker ‰ªªÂãôÊéíÁ®ã", "size": 20}, {"id": 53, "label": "Rubato", "group": "infra", "title": "Journey Ê†∏ÂøÉÂºïÊìé\nËß∏ÁôºË©ï‰º∞„ÄÅÁØÄÈªûÂü∑Ë°å\nÈÄ≤Â∫¶ÁÆ°ÁêÜ", "size": 22}, {"id": 54, "label": "Epistola", "group": "infra", "title": "Email Extension Service\niframe Á∑®ËºØÂô®„ÄÅË®äÊÅØ CRUD\nËàá MAAC Journey Êï¥Âêà", "size": 20}, {"id": 55, "label": "Cloud\nLogging", "group": "infra", "title": "GCP Cloud Logging\n‰∫ã‰ª∂Êó•Ë™åÊî∂ÈõÜ\nJourney Ëß∏Áôº‰∫ã‰ª∂‰æÜÊ∫ê", "size": 18}, {"id": 56, "label": "Contact\nEntity", "group": "data", "title": "ËÅØÁµ°‰∫∫Ë≥áÊñôÁâ©‰ª∂\nline_uid, customer_id, phone, email\nname, tags, custom_fields", "size": 22}, {"id": 57, "label": "Channel\nEntity", "group": "data", "title": "È†ªÈÅìÂØ¶È´î\nLINE / Email / SMS / WhatsApp / FB / IG\nchannel_id, status, config", "size": 20}, {"id": 58, "label": "Tag\nEntity", "group": "data", "title": "Ê®ôÁ±§Áâ©‰ª∂\ntag_id, name, source (maac/cdh)\nËá™ÂãïÊ®ô / ÊâãÂãïÊ®ô", "size": 18}, {"id": 59, "label": "Message\nEntity", "group": "data", "title": "Ë®äÊÅØÁâ©‰ª∂\nÊé®Êí≠/Ëá™ÂãïÂõûË¶Ü/Journey Ë®äÊÅØ\nÁØÑÊú¨„ÄÅRich Content", "size": 18}, {"id": 60, "label": "Event /\nWebhook", "group": "data", "title": "‰∫ã‰ª∂Áâ©‰ª∂\nLINE Webhook, CDH Event\nFollow / Unfollow / Message / Tag Change", "size": 20}], "edges": [{"from": 1, "to": 2, "label": "", "edge_type": "hierarchy"}, {"from": 1, "to": 3, "label": "", "edge_type": "hierarchy"}, {"from": 1, "to": 4, "label": "", "edge_type": "hierarchy"}, {"from": 1, "to": 5, "label": "", "edge_type": "hierarchy"}, {"from": 1, "to": 6, "label": "", "edge_type": "hierarchy"}, {"from": 1, "to": 7, "label": "", "edge_type": "hierarchy"}, {"from": 1, "to": 8, "label": "", "edge_type": "hierarchy"}, {"from": 1, "to": 9, "label": "", "edge_type": "hierarchy"}, {"from": 1, "to": 10, "label": "", "edge_type": "hierarchy"}, {"from": 1, "to": 11, "label": "", "edge_type": "hierarchy"}, {"from": 1, "to": 12, "label": "", "edge_type": "hierarchy"}, {"from": 1, "to": 13, "label": "", "edge_type": "hierarchy"}, {"from": 2, "to": 14, "label": "", "edge_type": "contains"}, {"from": 2, "to": 15, "label": "", "edge_type": "contains"}, {"from": 2, "to": 16, "label": "", "edge_type": "contains"}, {"from": 2, "to": 17, "label": "", "edge_type": "contains"}, {"from": 2, "to": 18, "label": "", "edge_type": "contains"}, {"from": 2, "to": 19, "label": "", "edge_type": "contains"}, {"from": 2, "to": 20, "label": "", "edge_type": "contains"}, {"from": 3, "to": 21, "label": "", "edge_type": "contains"}, {"from": 3, "to": 22, "label": "", "edge_type": "contains"}, {"from": 4, "to": 23, "label": "", "edge_type": "contains"}, {"from": 4, "to": 24, "label": "", "edge_type": "contains"}, {"from": 5, "to": 25, "label": "", "edge_type": "contains"}, {"from": 5, "to": 26, "label": "", "edge_type": "contains"}, {"from": 5, "to": 27, "label": "", "edge_type": "contains"}, {"from": 6, "to": 28, "label": "", "edge_type": "contains"}, {"from": 6, "to": 29, "label": "", "edge_type": "contains"}, {"from": 6, "to": 30, "label": "", "edge_type": "contains"}, {"from": 7, "to": 31, "label": "", "edge_type": "contains"}, {"from": 7, "to": 32, "label": "", "edge_type": "contains"}, {"from": 7, "to": 33, "label": "", "edge_type": "contains"}, {"from": 7, "to": 34, "label": "", "edge_type": "contains"}, {"from": 7, "to": 35, "label": "", "edge_type": "contains"}, {"from": 9, "to": 36, "label": "", "edge_type": "contains"}, {"from": 9, "to": 37, "label": "", "edge_type": "contains"}, {"from": 9, "to": 38, "label": "", "edge_type": "contains"}, {"from": 9, "to": 39, "label": "", "edge_type": "contains"}, {"from": 10, "to": 40, "label": "", "edge_type": "contains"}, {"from": 10, "to": 41, "label": "", "edge_type": "contains"}, {"from": 8, "to": 42, "label": "", "edge_type": "contains"}, {"from": 8, "to": 43, "label": "", "edge_type": "contains"}, {"from": 7, "to": 44, "label": "", "edge_type": "contains"}, {"from": 7, "to": 45, "label": "", "edge_type": "contains"}, {"from": 2, "to": 3, "label": "Êèê‰æõËÅØÁµ°‰∫∫", "edge_type": "data_flow"}, {"from": 2, "to": 5, "label": "Êé®Êí≠Â∞çË±°", "edge_type": "data_flow"}, {"from": 2, "to": 7, "label": "ÊóÖÁ®ãÊàêÂì°", "edge_type": "data_flow"}, {"from": 2, "to": 6, "label": "ÂõûË¶ÜÂ∞çË±°", "edge_type": "data_flow"}, {"from": 2, "to": 8, "label": "ÈÅ∏ÂñÆÂ∞çË±°", "edge_type": "data_flow"}, {"from": 2, "to": 9, "label": "Êï∏Êìö‰æÜÊ∫ê", "edge_type": "data_flow"}, {"from": 3, "to": 5, "label": "ÂèóÁúæÁØ©ÈÅ∏", "edge_type": "data_flow"}, {"from": 3, "to": 7, "label": "ÂÖ•Âè£Ê¢ù‰ª∂", "edge_type": "data_flow"}, {"from": 3, "to": 8, "label": "ÂàÜÁúæÈ°ØÁ§∫", "edge_type": "data_flow"}, {"from": 4, "to": 3, "label": "ÁØ©ÈÅ∏Ê¢ù‰ª∂", "edge_type": "data_flow"}, {"from": 4, "to": 2, "label": "Ê®ôË®òËÅØÁµ°‰∫∫", "edge_type": "data_flow"}, {"from": 4, "to": 8, "label": "ÈÅ∏ÂñÆÂàÜÁæ§‰æùÊìö", "edge_type": "data_flow"}, {"from": 4, "to": 7, "label": "Ëß∏Áôº/Âãï‰ΩúÊ¢ù‰ª∂", "edge_type": "data_flow"}, {"from": 4, "to": 9, "label": "Ë¶ÜËìãÁéáÁµ±Ë®à", "edge_type": "data_flow"}, {"from": 5, "to": 9, "label": "Êé®Êí≠ÊàêÊïà", "edge_type": "data_flow"}, {"from": 5, "to": 13, "label": "‰ΩøÁî®ÁØÑÊú¨", "edge_type": "data_flow"}, {"from": 27, "to": 3, "label": "ËÆÄÂèñÂàÜÁúæ", "edge_type": "data_flow"}, {"from": 6, "to": 4, "label": "Ëß∏ÁôºËá™ÂãïÂä†Ê®ô", "edge_type": "data_flow"}, {"from": 6, "to": 9, "label": "ÂõûË¶ÜÁµ±Ë®à", "edge_type": "data_flow"}, {"from": 7, "to": 5, "label": "Ëß∏ÁôºÊé®Êí≠", "edge_type": "data_flow"}, {"from": 7, "to": 4, "label": "Âä†/ÁßªÈô§Ê®ôÁ±§", "edge_type": "data_flow"}, {"from": 7, "to": 2, "label": "Êõ¥Êñ∞ËÅØÁµ°‰∫∫", "edge_type": "data_flow"}, {"from": 7, "to": 12, "label": "ÁçéÂìÅÁôºÊîæ", "edge_type": "data_flow"}, {"from": 10, "to": 2, "label": "Êñ∞ËÅØÁµ°‰∫∫Ê≠∏Âõ†", "edge_type": "data_flow"}, {"from": 10, "to": 9, "label": "Deeplink Â†±Ë°®", "edge_type": "data_flow"}, {"from": 11, "to": 9, "label": "ÈªûÊìäÂ†±Ë°®", "edge_type": "data_flow"}, {"from": 8, "to": 10, "label": "ÈÅ∏ÂñÆÈÄ£Áµê", "edge_type": "data_flow"}, {"from": 12, "to": 7, "label": "Journey ÁçéÂìÅÁØÄÈªû", "edge_type": "data_flow"}, {"from": 12, "to": 5, "label": "Êé®Êí≠‰∏≠ÁôºÁçé", "edge_type": "data_flow"}, {"from": 48, "to": 2, "label": "Webhook ÂêåÊ≠•", "edge_type": "infra_dep"}, {"from": 48, "to": 18, "label": "Â•ΩÂèãÁãÄÊÖã‰∫ã‰ª∂", "edge_type": "infra_dep"}, {"from": 48, "to": 19, "label": "Profile ÂêåÊ≠•", "edge_type": "infra_dep"}, {"from": 48, "to": 6, "label": "Êé•Êî∂Ë®äÊÅØ", "edge_type": "infra_dep"}, {"from": 48, "to": 5, "label": "Push Message", "edge_type": "infra_dep"}, {"from": 48, "to": 8, "label": "Rich Menu API", "edge_type": "infra_dep"}, {"from": 49, "to": 6, "label": "FB/IG Ë®äÊÅØ", "edge_type": "infra_dep"}, {"from": 49, "to": 30, "label": "ÊîøÁ≠ñÈôêÂà∂", "edge_type": "infra_dep"}, {"from": 50, "to": 33, "label": "Email ÁôºÈÄÅ", "edge_type": "infra_dep"}, {"from": 50, "to": 44, "label": "DNS È©óË≠â", "edge_type": "infra_dep"}, {"from": 50, "to": 45, "label": "Bounce/Spam Áõ£Êéß", "edge_type": "infra_dep"}, {"from": 51, "to": 9, "label": "Êó•Â†±Ë°® Pipeline", "edge_type": "infra_dep"}, {"from": 51, "to": 36, "label": "Tag Ë¶ÜËìãÁéáË®àÁÆó", "edge_type": "infra_dep"}, {"from": 51, "to": 39, "label": "ÈÄ±Â†±ÊéíÁ®ã", "edge_type": "infra_dep"}, {"from": 51, "to": 31, "label": "Time-Based Ëß∏Áôº", "edge_type": "infra_dep"}, {"from": 46, "to": 15, "label": "Áµ±‰∏Ä Profile", "edge_type": "infra_dep"}, {"from": 46, "to": 4, "label": "CDH Tag ÂêåÊ≠•", "edge_type": "infra_dep"}, {"from": 46, "to": 3, "label": "CDH ÂàÜÁúæË¶èÂâá", "edge_type": "infra_dep"}, {"from": 46, "to": 47, "label": "ÈõôÂêëÂêåÊ≠•", "edge_type": "infra_dep"}, {"from": 53, "to": 31, "label": "Ëß∏ÁôºË©ï‰º∞", "edge_type": "infra_dep"}, {"from": 53, "to": 34, "label": "ÈÄ≤Â∫¶ÁÆ°ÁêÜ", "edge_type": "infra_dep"}, {"from": 52, "to": 53, "label": "‰ªªÂãô‰ΩáÂàó", "edge_type": "infra_dep"}, {"from": 55, "to": 53, "label": "‰∫ã‰ª∂Êó•Ë™å", "edge_type": "infra_dep"}, {"from": 54, "to": 33, "label": "Email Á∑®ËºØ/ÁôºÈÄÅ", "edge_type": "infra_dep"}, {"from": 47, "to": 2, "label": "ÂÆ¢ÊúçÂ∞çË©±Ë≥áÊñô", "edge_type": "infra_dep"}, {"from": 56, "to": 2, "label": "Ê†∏ÂøÉË≥áÊñô", "edge_type": "data_entity"}, {"from": 56, "to": 15, "label": "Âêà‰ΩµÂ∞çË±°", "edge_type": "data_entity"}, {"from": 56, "to": 16, "label": "ÂåØÂÖ•ÁõÆÊ®ô", "edge_type": "data_entity"}, {"from": 57, "to": 2, "label": "ÈÄöË∑ØË≥áÊñô", "edge_type": "data_entity"}, {"from": 57, "to": 7, "label": "È†ªÈÅìË®≠ÂÆö", "edge_type": "data_entity"}, {"from": 57, "to": 5, "label": "ÁôºÈÄÅÈÄöË∑Ø", "edge_type": "data_entity"}, {"from": 58, "to": 4, "label": "Ê†∏ÂøÉË≥áÊñô", "edge_type": "data_entity"}, {"from": 58, "to": 3, "label": "ÁØ©ÈÅ∏‰æùÊìö", "edge_type": "data_entity"}, {"from": 58, "to": 46, "label": "CDH ÂêåÊ≠•", "edge_type": "data_entity"}, {"from": 59, "to": 5, "label": "Ë®äÊÅØÂÖßÂÆπ", "edge_type": "data_entity"}, {"from": 59, "to": 6, "label": "ÂõûË¶ÜÂÖßÂÆπ", "edge_type": "data_entity"}, {"from": 59, "to": 13, "label": "ÁØÑÊú¨‰æÜÊ∫ê", "edge_type": "data_entity"}, {"from": 59, "to": 7, "label": "Journey Ë®äÊÅØ", "edge_type": "data_entity"}, {"from": 60, "to": 31, "label": "Ëß∏Áôº‰∫ã‰ª∂", "edge_type": "data_entity"}, {"from": 60, "to": 18, "label": "ÁãÄÊÖã‰∫ã‰ª∂", "edge_type": "data_entity"}, {"from": 60, "to": 6, "label": "Ë®äÊÅØ‰∫ã‰ª∂", "edge_type": "data_entity"}, {"from": 60, "to": 48, "label": "Webhook", "edge_type": "data_entity"}]};

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
//  DESIGN CONFIG (APPLE STYLE)
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
const STYLES = {
  platform:   { color: '#0071E3', bg: '#0071E3', text: '#fff', shape: 'box', font: 18 },
  module:     { color: '#007AFF', bg: '#fff',    text: '#1D1D1F', shape: 'box', font: 16 },
  subfeature: { color: '#34C759', bg: '#fff',    text: '#1D1D1F', shape: 'box', font: 14 },
  infra:      { color: '#FF9500', bg: '#FFF6E5', text: '#1D1D1F', shape: 'dot', font: 12 },
  data:       { color: '#AF52DE', bg: '#F9F0FF', text: '#1D1D1F', shape: 'dot', font: 12 }
};

const EDGE_COLORS = {
  default: '#E5E5EA',
  data_flow: '#8ECAE6',
  infra_dep: '#FFD6A5',
  contains: '#F2F2F7'
};

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
//  DATA PREPARATION
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
const nodes = RAW_DATA.nodes.map(n => {
  const s = STYLES[n.group] || STYLES.module;
  const isBox = s.shape === 'box';
  
  return {
    id: n.id,
    label: isBox ? `  ${n.label.replace(/\n/g, ' ')}  ` : n.label.replace(/\n/g, '\n'), // Add padding to box labels
    group: n.group,
    title: n.title,
    shape: s.shape,
    size: isBox ? undefined : (n.group === 'infra' ? 10 : 6), // Dots need size
    color: {
      background: s.bg,
      border: s.color,
      highlight: { background: s.bg, border: s.color }
    },
    font: {
      color: isBox && s.bg !== '#fff' ? '#fff' : '#1D1D1F',
      size: s.font,
      face: 'SF Pro Text, -apple-system, sans-serif',
      multi: 'html',
      vadjust: isBox ? 0 : 5 // Push text down for dots
    },
    borderWidth: isBox ? 2 : 0, // No border for dots usually, clear border for boxes
    borderWidthSelected: 3,
    shadow: { enabled: true, color: 'rgba(0,0,0,0.06)', size: 10, x: 0, y: 4 },
    margin: isBox ? 12 : 5,
    heightConstraint: isBox ? { minimum: 36 } : false,
    
    // Custom data
    _orig: s
  };
});

const edges = RAW_DATA.edges.map((e, i) => {
  const isContains = e.edge_type === 'hierarchy' || e.edge_type === 'contains';
  return {
    id: i, from: e.from, to: e.to,
    label: isContains ? '' : (e.label || ''),
    color: { 
      color: isContains ? '#F2F2F7' : (EDGE_COLORS[e.edge_type] || '#D1D1D6'), 
      opacity: isContains ? 0.3 : 0.8 
    },
    arrows: isContains ? '' : 'to',
    width: isContains ? 1 : 1.5,
    font: { size: 10, color: '#86868B', align: 'middle', strokeWidth: 0, background: 'rgba(255,255,255,0.8)' },
    smooth: { type: isContains ? 'straightCross' : 'curvedCW', roundness: 0.2 }
  };
});

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
//  VIS NETWORK INIT
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
const container = document.getElementById('graph-container');
const data = { nodes: new vis.DataSet(nodes), edges: new vis.DataSet(edges) };
const options = {
  physics: {
    forceAtlas2Based: {
      gravitationalConstant: -150, // Less repulsion
      centralGravity: 0.01,
      springLength: 250, // Longer springs for breathing room
      damping: 0.4
    },
    maxVelocity: 50,
    solver: 'forceAtlas2Based',
    timestep: 0.35,
    stabilization: { iterations: 150 }
  },
  interaction: { hover: true, tooltipDelay: 300, hideEdgesOnDrag: true },
  layout: { improvedLayout: true }
};
const network = new vis.Network(container, data, options);

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
//  INTERACTION LOGIC
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
let impactMode = false;

// Filter
document.querySelectorAll('.filter-btn').forEach(btn => {
  btn.addEventListener('click', e => {
    document.querySelectorAll('.filter-btn').forEach(b => b.classList.remove('active'));
    e.target.classList.add('active');
    const group = e.target.dataset.filter;
    
    data.nodes.forEach(n => {
      const visible = group === 'all' || n.group === group || n.group === 'platform';
      data.nodes.update({ id: n.id, opacity: visible ? 1 : 0.1 });
    });
  });
});

// Search
document.getElementById('search').addEventListener('input', e => {
  const val = e.target.value.toLowerCase();
  if (!val) { resetView(); return; }
  
  const matches = data.nodes.get().filter(n => n.label.toLowerCase().includes(val));
  const ids = matches.map(n => n.id);
  
  data.nodes.forEach(n => {
    const isMatch = ids.includes(n.id);
    data.nodes.update({ id: n.id, opacity: isMatch ? 1 : 0.1 });
  });
  
  if (ids.length === 1) network.focus(ids[0], { scale: 1.2, animation: true });
});

// Click
network.on('click', params => {
  if (params.nodes.length) {
    const nid = params.nodes[0];
    if (impactMode) analyzeImpact(nid);
    else showDetail(nid);
  } else {
    if (!impactMode) closeDetail();
  }
});

function showDetail(nid) {
  const n = data.nodes.get(nid);
  const s = STYLES[n.group];
  
  // Get connections
  const connected = network.getConnectedEdges(nid);
  const rels = connected.map(eid => {
    const e = data.edges.get(eid);
    const isSource = e.from === nid;
    const neighborId = isSource ? e.to : e.from;
    const neighbor = data.nodes.get(neighborId);
    return {
      name: neighbor.label.trim(),
      type: e.label || 'Connection',
      dir: isSource ? '‚Üí Impacts' : '‚Üê Driven by',
      id: neighborId
    };
  });

  const html = `
    <div class="panel-header">
      <div class="panel-badge" style="background:${s.bg === '#fff' ? s.color+'20' : s.bg}; color:${s.bg === '#fff' ? s.color : '#fff'}">${n.group}</div>
      <div class="panel-title" style="color:${s.color}">${n.label.trim()}</div>
    </div>
    <div class="panel-body">
      <div class="panel-desc">${n.title || 'No description available.'}</div>
      
      <div class="rel-section">
        <h4>Connections (${rels.length})</h4>
        <div class="rel-list">
          ${rels.map(r => `
            <div class="rel-item" onclick="network.focus(${r.id}, {scale:1.2, animation:true}); showDetail(${r.id})">
              <span class="rel-icon">${r.dir.includes('‚Üí') ? '‚Üò' : '‚Üñ'}</span>
              <span class="rel-name">${r.name}</span>
              <span class="rel-type">${r.type}</span>
            </div>
          `).join('')}
        </div>
      </div>
      
      <button class="action-btn btn-impact" style="width:100%" onclick="enterImpact(${nid})">‚ö° Analyze Impact</button>
    </div>
  `;
  
  document.getElementById('detail-content').innerHTML = html;
  document.getElementById('detail-panel').classList.add('open');
}

function closeDetail() {
  document.getElementById('detail-panel').classList.remove('open');
}

// Impact Analysis
document.getElementById('impact-btn').addEventListener('click', () => {
  impactMode = !impactMode;
  document.getElementById('impact-btn').classList.toggle('active', impactMode);
  document.getElementById('impact-banner').classList.toggle('show', impactMode);
  if (!impactMode) resetView();
});

function enterImpact(nid) {
  impactMode = true;
  document.getElementById('impact-btn').classList.add('active');
  document.getElementById('impact-banner').classList.add('show');
  analyzeImpact(nid);
}

function exitImpact() {
  impactMode = false;
  document.getElementById('impact-btn').classList.remove('active');
  document.getElementById('impact-banner').classList.remove('show');
  document.getElementById('impact-list').classList.remove('show');
  resetView();
}

function analyzeImpact(rootId) {
  const root = data.nodes.get(rootId);
  document.getElementById('impact-msg').innerText = `Analyzing impact for: ${root.label.trim()}`;
  
  // BFS
  const affected = new Map(); // id -> level
  const queue = [{id: rootId, lvl: 0}];
  affected.set(rootId, 0);
  
  const visitedEdges = new Set();

  while(queue.length) {
    const {id, lvl} = queue.shift();
    if (lvl >= 3) continue;
    
    const edges = network.getConnectedEdges(id);
    edges.forEach(eid => {
      const e = data.edges.get(eid);
      // Logic: Only follow "impact" directions (Data Flow, Dependency)
      // Or Hierarchy (Child -> Parent often implies impact)
      
      let nextId = null;
      if (e.from === id) nextId = e.to; // Forward flow
      
      if (nextId && !affected.has(nextId)) {
        affected.set(nextId, lvl + 1);
        queue.push({id: nextId, lvl: lvl + 1});
        visitedEdges.add(eid);
      }
    });
  }

  // Visual Update
  const allNodes = data.nodes.get();
  allNodes.forEach(n => {
    if (affected.has(n.id)) {
      const lvl = affected.get(n.id);
      data.nodes.update({ 
        id: n.id, 
        opacity: 1,
        color: { background: lvl === 0 ? '#FF3B30' : '#fff', border: '#FF3B30' },
        font: { color: lvl === 0 ? '#fff' : '#000' }
      });
    } else {
      data.nodes.update({ id: n.id, opacity: 0.1 });
    }
  });
  
  // Update List
  const list = document.getElementById('impact-content');
  const items = Array.from(affected.entries()).sort((a,b) => a[1] - b[1]);
  list.innerHTML = items.map(([id, lvl]) => {
    const n = data.nodes.get(id);
    return `
      <div class="impact-row" onclick="network.focus(${id}, {scale:1.5, animation:true})">
        <span class="depth-tag">L${lvl}</span>
        <span>${n.label.trim()}</span>
      </div>
    `;
  }).join('');
  document.getElementById('impact-list').classList.add('show');
}

function resetView() {
  data.nodes.forEach(n => {
    const s = STYLES[n.group] || STYLES.module;
    data.nodes.update({
      id: n.id,
      opacity: 1,
      color: { background: s.bg, border: s.color },
      font: { color: s.shape === 'box' && s.bg !== '#fff' ? '#fff' : '#1D1D1F' }
    });
  });
}

</script>
</body>
</html>